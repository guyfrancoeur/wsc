<!doctype html>
<html>
<head>
  <title>wsc v2.1h</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" id="favicon">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">
  <link rel="stylesheet" type="text/css" href="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="./style.css">
  <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.0/umd/popper.min.js"></script>
  <script src="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/bootstrap.min.js"></script>
</head>
<body>
  <form>
    <div id="name-div" class="row">
      <div class="col-sm-5">
        <div class="input-group">
          <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
          <input type="text" class="input-sm" name="name" id="name" placeholder="Quel est votre pseudo/nickname" required />
        </div>
      </div>
      <div class="col-sm-2  col-sm-offset-2">
        <div class="input-group">
          <input type="text" class="input-sm" name="port" id="port" placeholder="Port" required />
        </div>
      </div>
      <div class="col-sm-2">
        <div class="input-group">
          <input type="text" class="input-sm" name="motsecret" id="motsecret" placeholder="Mot secret" required />
        </div>
      </div>
      <div class="col-sm-1 text-right">
        <button class="btn btn-sm btn-primary" id="bName"><i class="glyphicon glyphicon-ok"></i></button>
      </div>
      <br/>
    </div>
    <div id="welcome"><span id="arrow" class="glyphicon glyphicon-menu-right"></span> <span id="welcometext"></span></div>
    <div id="msgs">
      <ul id="messages" class="scrollbar">
        <!--<li>7/14/2020, 5:15:59 AM <strong> User</strong> : lol</li>-->
      </ul>
    </div>
    <div id="input-div">
      <div id="divdubas" class="input-group">
        <span id="eltG" class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
        <textarea id="message" name="message" class="form-control" autocomplete="off" placeholder="Ecrire votre message ici" rows="3" style="width: 100%;"></textarea>
        <div class="input-group-btn">
          <button id="bS" class="btn btn-primary"><i class="glyphicon glyphicon-share"></i></button> &nbsp;
          <button id="bF" class="btn btn-success"><i class="glyphicon glyphicon-file"></i></button>
          <a tabIndex="0" id="bH" class="btn btn-default" role="button" data-trigger="focus" data-original-title="<strong>Hint</strong>" data-content="<ul style='padding-left:10px;'><li>Utilisez SHIFT-Enter pour envoyer votre message.</li> <li>Cliquer &#160;<span id='bmodaleusers' class='glyphicon glyphicon-user'></span>, pour voir les usagers connectés</li></ul>" data-toggle="popover" data-placement="top">
            <span class="glyphicon glyphicon-info-sign"></span>
          </a>
        </div>
      </div>
    </div>
  </form>

<!--<div class="modal" tabindex="-1" role="dialog"> ceci va dans la page principale -->
<div class="modal fade" id="m_i" tabindex="-1" role="dialog" aria-labelledby="m_iTitle" aria-hidden="true">
  <div class="modal-dialog" role="document" style="max-width: 450px">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h3 class="modal-title col text-center">Image</h3>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <div class="input-group">
            <span class="input-group-addon" id="inputGroupFileAddon01"><i class="glyphicon glyphicon-picture"></i></span>
            <input onchange="readURL(this);" type="file" class="form-control" id="fName" placeholder="PNG, JPG" aria-describedby="inputGroupFileAddon01">
            <span class="input-group-addon" id="inputGroupFileAddon02">png, jpg</span>
          </div>
        </div>
        <img id="preview" src="" class="img-responsive"/>
      </div>
      <div class="modal-footer">
        <button id="bmSubmit" type="button" class="btn btn-primary"><i class="glyphicon glyphicon-send"></i></button>
      </div>
    </div>
  </div>
</div>
<!-- modal start -->
<div class="toast m-0" id="toast1" data-autohide="false" data-animation="true" aria-live="polite" aria-atomic="true">
  <div class="toast-header pb-4">
    <div class="container-fluid p-0">
      <div class="divIconeModale"><i id="iconuser" class="glyphicon glyphicon-user"></i></div>
      <div id="ticket"></div>
      <div class="col"></div>
      <div class="col"></div>
      <div class="col ml-auto">
        <button id="closeToast" type="button" class="close" data-dismiss="toast" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
  </div>
  <div class="toast-body text-center">
    <div id ="firstline" style="cursor:default;">
      <p class="mr-auto"><span id="usagersconnectes">Usagers connectés : </span><span id="count" class="label label-success">2</span></p>
    </div>
    <hr class="style-two" style="height:1px; width:150px;margin-left:auto !important;margin-right:auto !important;">
      <ul class="listeusagers" id="users">
      </ul>
    <br/>
  </div>
</div>
<!-- modal end -->
<!-- </div> -->

<script>
  var a1 = new Audio('./consequence.mp3');
  var a2 = new Audio('./inbox.mp3');
  //ws = new WebSocket("wss://www.salutem.co:1337/");
  var elem = document.getElementById('messages'); //pour scroll-auto
  
  const ico = document.getElementById('favicon');

  function newUpdate() {
    ico.href = './ico/favicon.ico';
  }

  $(window).on("blur focus", function(e) {
    ico.href = './favicon.ico';
  });

  //Fermeture en cliquant sur la croix
  $('#closeToast').click(function() {
    $('#toast1').hide();
  });

  function fResize() {
    $('#bS').height($('#message').height());
    $('#bF').height($('#message').height());
    $('#bH').height($('#message').height());
    $('#message').css('width','100%');
    if (connecte == 0){
      $('#msgs').height($(window).height() - $('#name-div').height() - $('#input-div').height() - 40);
      $('#messages').height($(window).height() - $('#name-div').height() - $('#input-div').height() - 40);
    }
    else{
      $('#msgs').height($(window).height() - $('#welcome').height() - $('#input-div').height() - 40);
      $('#messages').height($(window).height() - $('#welcome').height() - $('#input-div').height() - 40);
    }
  }

  ws.onmessage = function(evt) {
    //console.log(evt);
    if (evt.data != "") {
      data = JSON.parse(evt.data);
      //console.log(data);
      switch (data.type) {
       case 'lnk' : $('#count').text(data.count); $('#users').empty(); $('#users').append(data.message); break;
       case 'tlk' :
         if (!document.hasFocus()) { newUpdate(); a2.play(); }
         var text = data.message;
         text = text.replace(/\r?\n/g, '<br />');
         $('#messages').append($('<li>').html(text));
         elem.scrollTop = elem.scrollHeight;
         break;
      }
    }
  };

  ws.onerror = function(evt) {
    $('#messages').append($('<li>').html('<span style="color: red;">ERROR:</span> ' + evt.data));
  };

  ws.onopen = function(evt) {
    ws.send(JSON.stringify({
       type: 'link',
       name: '',
       message: navigator.tell
     }));
  };

  var connecte = 0;
  $('#bName').on('click', function(){
    $('#name').val($.trim($('#name').val()));
    if ($('#name').val().length > 0 && $('#port').val().length > 0 && $('#motsecret').val().length > 0) {
      $('#name-div').hide();
      $('#welcome').show();
      $('#welcometext').text('Bonjour ' + $('#name').val());
      ws.send(JSON.stringify({
       type: 'name',
       name: $('#name').val(),
       message: navigator.tell
      }));
      connecte = 1;
      fResize();
      $('#toast1').css('top','5rem');
      return false;
    }
  });

  $('#bS').on('click', function(){
  	$('#name').val($.trim($('#name').val()));
    if ($('#name').val().length > 0) {
      ws.send(JSON.stringify({
        type: 'talk',
        name: $('#name').val(),
        message: $('#message').val()
      }));
      $('#message').focus();
      $('#message').val('');
      return false;
    }
  });

  $('#bF').on('click', function(){ $('#m_i').modal('show'); return false; });

  $('#bmSubmit').on('click', function(){
    ws.send(JSON.stringify({
       type: 'img',
       name: $('#name').val(),
       message: $('#preview').attr('src')
     }));
     $("#m_i").modal('hide');
  });

  $('#message').on('mouseup', fResize);

  $(window).on('resize', function(){
    var win = $(this); //this = window
    $('#msgs').height(win.height() - $('#name-div').height() - $('#input-div').height() - 40);
    $('#messages').height(win.height() - $('#name-div').height() - $('#input-div').height() - 40);
    $('#message').width($('#input-div').width() - $('#bMsg').width() - 100);
    fResize();
  });

  navigator.tell = (function(){
  var ua = navigator.userAgent, tem, M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
  if(/trident/i.test(M[1])){
    tem =  /\brv[ :]+(\d+)/g.exec(ua) || [];
    return 'IE '+(tem[1] || '');
  }
  if(M[1] === 'Chrome'){
      tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
      if(tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
  }
  M = M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
  if((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
  return M.join(' ');
  })();

  function readURL(input) {
    var reader = new FileReader();

    reader.onloadend = function () {
      $('#preview').attr('src', this.result);
    };

    if (input.files && input.files[0]) {
      reader.readAsDataURL(input.files[0]);
    } else {
      $('#preview').attr('src', "");
    }
  }

  function KeyPress(e) {
    var evtobj = window.event ? event : e
    if (evtobj.keyCode == 13 && evtobj.shiftKey) {
      e.preventDefault();
      if ($("#message").val().length > 0) {
        $('#bS').click();
      }
      return true;
    }
    if (evtobj.ctrlKey && evtobj.keyCode == '0'.charCodeAt(0)) {
      var text = $("#message").val();
      text = text.replace(/\</g, '&#60;');
      $("#message").val(text);
      return true;
    }
    if (evtobj.ctrlKey && evtobj.keyCode == '9'.charCodeAt(0)) {
      var text = $("#message").val();
      var text = '<pre>'+ $("#message").val() +'</pre>';
      $("#message").val(text);
      return true;
    }
  }
  document.onkeydown = KeyPress;

  // Ouverture modal start
  $("[data-toggle='popover']").on('shown.bs.popover', function(){
    $('#bmodaleusers').click(function() {
      $("#toast1").show();
    });
  });

  $(document).ready(function(){
    //$('[data-toggle="tooltip"]').tooltip();
    $('#welcome').hide();
    $('[data-toggle="popover"]').popover({html: true});
    $('#msgs').height($(window).height() - $('#name-div').height() - $('#input-div').height() - 40);
    $('#messages').height($(window).height() - $('#name-div').height() - $('#input-div').height() - 40);
    $('#message').width($('#input-div').width() - $('#bMsg').width() - 100);
    a1.play();
    fResize();
    console.log('server 24');
  });
</script>
</body>
</html>
